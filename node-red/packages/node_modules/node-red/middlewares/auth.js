var passport = require("passport");
var strategies = require("../../@node-red/editor-api/lib/auth/strategies");

passport.use(strategies.bearerStrategy.BearerStrategy);
passport.use(strategies.clientPasswordStrategy.ClientPasswordStrategy);
passport.use(strategies.anonymousStrategy);
passport.use(strategies.tokensStrategy);

const requireLogin = (req, res, next) => {
    try {
        passport.authenticate(['bearer','tokens','anon'],{ session: false })(req, res, function() {
            console.log(req.user)
            if (req.user) {
                next();
            }
            else {
                res.status(401).send("Unauthorized");
            }
        });
    } catch (error) {
        console.log(error);
        res.status(401).send("Unauthorized");
    }
}

const requireRole = (...checkRole) => {
    return (req, res, next) => {
      if (req.user.permissions && checkRole.includes(req.user.permissions)) {
        next();
      } else {
        res.status(403).send("Forbidden");
      }
    };
};

module.exports = {
    requireLogin,
    requireRole,
};
  